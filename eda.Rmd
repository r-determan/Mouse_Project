---
title: "EDA"
output: pdf_document
date: '2022-04-07'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(R.matlab, stringr, tidyr, ggplot2, hexbin, dplyr, reshape2)

```

## questions
1. What does each file represent -- Zero_Maze has 13 sub folders with binned_zscore and binned_behavior. Is each a mouse?   Yes.
2. In the binned_behavior should each row have a 1 and a 0. Not 0,0. The mouse is either in the open arm or in the closed arm. There is no "other" option. (0&0 is because program lost track of mouse. Just remove them.)
3. Column one of binned zscore does not always represent the same cell. They recorded from different number of cells in each animal. For folders of the same animals between different behaviors, they were recorded on different days.
4. For same animals, are recording independent or time series?

## notes --
```binned_zscore.m``` = single cell recordings; col = each cell; row = each time  
```binned_behavior.m``` = animal behavior

Mouse Tasks:   
- Elevated Zero Maze; col1 = closed arm; col2 = open arm  
- Opposite Sex; col1 = interacting with male cup; col2 = interacting with female cup 
- Direct Interaction; col1 = interacting; col2 = non-social behavior/ rearing


# Zero Maze
```{r}
# read in our data
prefix <- "Data/Zero_Maze/"
folders <- list.files(prefix)

bz_all <- NULL
for (f in folders){
 #abbreviation for file name
 f_abbr <- str_sub(f, -3, -1)
 #subfolder
 sub_f <- list.files(paste0(prefix, f, "/Day_1/Trial_001_0"))
 
 # MAKE EACH MOUSE IN ITS OWN VARIABLE
 #binned behavior
 assign(paste0("bb_",f_abbr), 
         readMat(paste0(prefix, f, "/Day_1/Trial_001_0/binned_behavior.mat")))
 
 #z score
 assign(paste0("bz_",f_abbr), 
         readMat(paste0(prefix, f, "/Day_1/Trial_001_0/binned_zscore.mat")))
  
 
 # ADD ALL MICE TO SAME VARIABLE
 #import data
  bb <- readMat(paste0(prefix, f, "/Day_1/Trial_001_0/binned_behavior.mat"))
  bz <- readMat(paste0(prefix, f, "/Day_1/Trial_001_0/binned_zscore.mat"))
 
 #extract dataframes from list
  bb <- t(bb$binned.behavior)
  bz <- data.frame(bz$binned.zscore)
 
 #add behavior to zscore dataframe
  bz$open <- bb[,2]
  bz$closed <- bb[,1]
 #add row number as time proxy
  bz$time <- seq(1:nrow(bz))

  #pivot long and add all data to a single dataframe
  bz_long <- bz %>% pivot_longer(cols = -c(open, closed, time)) %>% mutate(df = f_abbr)
  bz_all <- rbind(bz_all, bz_long)
}
```

## Example with sub folder 251

 If I understand the data layout correctly, there are 32 neurons that are being tracked

```{r}
x <- t(bb_251$binned.behavior)
z <- data.frame(bz_251$binned.zscore)


z$open <- x[,2]
z$closed <- x[,1]
z$time <- seq(1:nrow(z))

z_long <- z %>% pivot_longer(cols = X1:X32)

# ggplot(data = bz_long, mapping = aes(x = name, y = value, fill = as.factor(open)))+
#   geom_violin(position = position_dodge())+
#   labs(title = "Distributions of Neuron Z-Scores", fill = "Open?")+
#     theme(legend.position = "bottom")


ggplot(data = bz_long, mapping = aes(x = name, y = value))+
  stat_bin2d(bins = 25, drop= TRUE, aes(fill = ..density..))+
  scale_fill_viridis_c()+
  labs(title = "Heatmap of Activation: Open = 1, Closed = 0", x = "Neuron", y = "Z-score")+
  facet_wrap(vars(open), ncol = 1)+
  theme(legend.position = "bottom")

```

### Time Series Plot for Neurons(not consider about behavior)
```{r}
for (i in 1:32){index[i] <- paste0("X",i)}

ggplot(z_long[z_long$name %in% index[1:10],])+
  aes(x=time,y=value,group=name,color=name)+
  geom_line()+
  facet_wrap(~name,nrow=2)+
  xlab("time")+ylab("activity level")+labs(color="neurons")

ggplot(z_long[z_long$name %in% index[11:20],])+
  aes(x=time,y=value,group=name,color=name)+
  geom_line()+
  facet_wrap(~name,nrow=2)+
  xlab("time")+ylab("activity level")+labs(color="neurons")

ggplot(z_long[z_long$name %in% index[21:32],])+
  aes(x=time,y=value,group=name,color=name)+
  geom_line()+
  facet_wrap(~name,ncol=5)+
  xlab("time")+ylab("activity level")+labs(color="neurons")
```

### Bar Plot for Neurons' Average Zscore for Different Behavior
```{r}
##data cleaning
z_long_clean <- z_long[-which(z_long$open==0 & z_long$closed==0),]
z_long_clean$Y <- NA
z_long_clean$Y[z_long_clean$open==1] <- "open"
z_long_clean$Y[z_long_clean$closed==1] <- "closed"
z_long_clean_temp <- z_long_clean[,3:ncol(z_long_clean)] %>% group_by(Y,name) %>% summarise(avg=mean(value)) %>% arrange(name)

##compare average zscore for different behavior based on each neurons
ggplot(z_long_clean_temp)+
  geom_bar(aes(x=name,y=avg,fill=Y),stat = "identity",position="dodge")+
  xlab("neurons")+ylab("average zscore")+labs(fill="behavior",title="folder 251")

##compare overall average zscore for different behavior
(z_long_clean_temp %>% group_by(Y) %>% summarise(overall=mean(avg))) ##are very close
```
After dropped 0&0 data, I split them into 2 groups, open & closed, and then calculated average zscore for each neuron, drew bar plot.

From this plot, we can see some neurons show more active in closed arm than in open arm, while other neurons are opposite, so we can assume some neurons has different working patterns.
